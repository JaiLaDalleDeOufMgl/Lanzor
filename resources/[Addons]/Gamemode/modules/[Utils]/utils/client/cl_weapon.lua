

local weapons = {
	[`WEAPON_UNARMED`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},

	[`WEAPON_KNIFE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_NIGHTSTICK`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_HAMMER`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_BAT`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_CROWBAR`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_GOLFCLUB`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_BOTTLE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_DAGGER`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_HATCHET`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_KNUCKLE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MACHETE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_FLASHLIGHT`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	-- [`WEAPON_SWITCHBLADE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_BATTLEAXE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_POOLCUE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_WRENCH`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},

	[`WEAPON_PISTOL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_PISTOL_MK2`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_COMBATPISTOL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_PISTOL50`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_SNSPISTOL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_SNSPISTOL_MK2`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_HEAVYPISTOL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_VINTAGEPISTOL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MARKSMANPISTOL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_REVOLVER`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_REVOLVER_MK2`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_DOUBLEACTION`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_APPISTOL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_STUNGUN`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_FLAREGUN`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_CERAMICPISTOL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_NAVYREVOLVER`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_GADGETPISTOL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},

	[`WEAPON_MICROSMG`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MACHINEPISTOL`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MINISMG`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_SMG`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_SMG_MK2`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_ASSAULTSMG`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_COMBATPDW`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MG`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_COMBATMG`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_COMBATMG_MK2`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_GUSENBERG`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},

	[`WEAPON_ASSAULTRIFLE`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_ASSAULTRIFLE_MK2`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_CARBINERIFLE`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_CARBINERIFLE_MK2`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_ADVANCEDRIFLE`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_SPECIALCARBINE`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_SPECIALCARBINE_MK2`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_BULLPUPRIFLE`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_BULLPUPRIFLE_MK2`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_COMPACTRIFLE`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MILITARYRIFLE`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_HEAVYRIFLE`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_TACTICALRIFLE`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_PUMPSHOTGUN`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_PUMPSHOTGUN_MK2`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_SAWNOFFSHOTGUN`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_BULLPUPSHOTGUN`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_ASSAULTSHOTGUN`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MUSKET`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_HEAVYSHOTGUN`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_DBSHOTGUN`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_AUTOSHOTGUN`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_COMBATSHOTGUN`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},

	[`WEAPON_SNIPERRIFLE`] = {parameters = {anim = true, onlyBag = true, scoped = true, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_HEAVYSNIPER`] = {parameters = {anim = true, onlyBag = true, scoped = true, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_HEAVYSNIPER_MK2`] = {parameters = {anim = true, onlyBag = true, scoped = true, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MARKSMANRIFLE`] = {parameters = {anim = true, onlyBag = true, scoped = true, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MARKSMANRIFLE_MK2`] = {parameters = {anim = true, onlyBag = true, scoped = true, shakeCam = 0, infiniteAmmo = false}},

	[`WEAPON_GRENADELAUNCHER`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_RPG`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_STINGER`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MINIGUN`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_FIREWORK`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_RAILGUN`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0.0, infiniteAmmo = false}},
	[`WEAPON_HOMINGLAUNCHER`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_COMPACTLAUNCHER`] = {parameters = {anim = true, onlyBag = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MEGAPHONE`] = {parameters = {anim = true, onlyBag = false, scoped = false, shakeCam = 0, infiniteAmmo = false}}, 
	[`WEAPON_ANTIDOTE`] = {parameters = {anim = true, onlyBag = false, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_GRENADE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_STICKYBOMB`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_PROXMINE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_SMOKEGRENADE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_BZGAS`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_MOLOTOV`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_FIREEXTINGUISHER`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = true}},
	[`WEAPON_PETROLCAN`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = true}},
	[`WEAPON_BALL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_SNOWBALL`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_FLARE`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}},
	[`WEAPON_PIPEBOMB`] = {parameters = {anim = true, scoped = false, shakeCam = 0, infiniteAmmo = false}}
}

local unarmedHash = `WEAPON_UNARMED`
local currWeapon = unarmedHash
local holstered = true
local canFire = true
local weaponbypass = false
local weaponbypass2 = false


RegisterCommand("weaponbypass", function()
	weaponbypass = not weaponbypass
	if ESX.GetPlayerData()['group'] == "fondateur" then
		if not weaponbypass then
			ESX.ShowNotification("weaponbypass "..exports.Tree:serveurConfig().Serveur.color.."désactivé")
			weaponbypass2 = false
		else
			weaponbypass2 = true
			ESX.ShowNotification("weaponbypass ~g~activé")
		end
	else
		ESX.ShowNotification("Permission invalide")
	end
end)

CreateThread(function()
	while not ESX.IsPlayerLoaded() do
		Wait(500)
	end
	
	while true do
		local Player = PlayerPedId();
		local weapoin = GetSelectedPedWeapon(Player);
		local armesdon = GetHashKey(weapoin);

        if (not IsPedArmed(PlayerPedId(), 1)) and (GetSelectedPedWeapon(PlayerPedId()) ~= GetHashKey('weapon_unarmed')) then
            Interval = 0
        else
            Interval = 1000
        end

		if ( not weaponbypass2 ) then
			if DoesEntityExist(Player) and not IsPedDeadOrDying(Player) and IsPedOnFoot(Player) then
				local newWeap = GetSelectedPedWeapon(Player)
				if newWeap ~= currWeapon then
					SetCurrentPedWeapon(Player, currWeapon, true)
					local continue = true
					if (weapons[newWeap] ~= nil) and (weapons[newWeap].parameters.onlyBag) then
						local bagIndex = GetPedDrawableVariation(Player, 5)
							if bagIndex == 41 or bagIndex == 105 or bagIndex == 101 or bagIndex == 64 or bagIndex == 63 or bagIndex == 59 or bagIndex == 60 or bagIndex == 117 then
						else
							local vehicle = ESX.Game.GetVehicleInDirection()
							if DoesEntityExist(vehicle) then
								SetVehicleDoorOpen(vehicle, 5, false, false)
								Citizen.Wait(2000)
								SetVehicleDoorShut(vehicle, 5, false)
							else
								ESX.ShowNotification(exports.Tree:serveurConfig().Serveur.color.."Action Impossible~s~ : Vous devez disposer d'un sac ou être proche d'une voiture.")
								continue = false
							end
						end
					end

					if continue then
						ESX.Streaming.RequestAnimDict('reaction@intimidation@1h')
						if (weapons[newWeap] ~= nil) and (weapons[newWeap].parameters.anim) and (GetPedParachuteState(GetPlayerPed(-1)) == -1 or GetPedParachuteState(GetPlayerPed(-1)) == 0) then
							if holstered then
								canFire = false
								TaskPlayAnimAdvanced(Player, 'reaction@intimidation@1h', 'intro', GetEntityCoords(Player), 0, 0, GetEntityHeading(Player), 8.0, 3.0, -1, 50, 0, 0, 0)
								Citizen.Wait(1000)
								SetCurrentPedWeapon(Player, newWeap, true)
								currWeapon = newWeap
								Citizen.Wait(2000)
								ClearPedTasks(Player)
								holstered = false
								canFire = true
							elseif newWeap ~= currWeapon then
								canFire = false
								TaskPlayAnimAdvanced(Player, 'reaction@intimidation@1h', 'outro', GetEntityCoords(Player), 0, 0, GetEntityHeading(Player), 8.0, 3.0, -1, 50, 0, 0, 0)
								SetCurrentPedWeapon(Player, unarmedHash, true)
								SetCurrentPedWeapon(Player, newWeap, true)
								currWeapon = newWeap
								Citizen.Wait(2000)
								ClearPedTasks(Player)
								holstered = false
								canFire = true
							end
						else
							if not holstered and (weapons[currWeapon] ~= nil) and (weapons[currWeapon].parameters.anim) then
								canFire = false
								TaskPlayAnimAdvanced(Player, 'reaction@intimidation@1h', 'outro', GetEntityCoords(Player), 0, 0, GetEntityHeading(Player), 8.0, 3.0, -1, 50, 0, 0, 0)
								SetCurrentPedWeapon(Player, unarmedHash, true)
								ClearPedTasks(Player)
								SetCurrentPedWeapon(Player, newWeap, true)
								holstered = true
								canFire = true
								currWeapon = newWeap
							else
								SetCurrentPedWeapon(Player, newWeap, true)
								holstered = false
								canFire = true
								currWeapon = newWeap
							end
						end
						RemoveAnimDict('reaction@intimidation@1h')
					end
				end
			end

			if not canFire then
				DisableControlAction(0, 25, true)
				DisablePlayerFiring(PlayerPedId(), true)
			end
		end
        Wait(Interval)
	end
end)